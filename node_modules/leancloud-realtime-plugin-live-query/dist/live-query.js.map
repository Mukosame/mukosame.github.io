{"version":3,"file":"live-query.js","sources":["../src/realtime.js","../src/live-query-client.js","../src/index.js"],"sourcesContent":["/* eslint-disable import/no-unresolved */\nimport { Protocals, Promise as _Promise } from 'leancloud-realtime/core';\n\nif (!Protocals) {\n  throw new Error('LeanCloud Realtime SDK not installed');\n}\nexport { _Promise };\n\nexport { Protocals, EventEmitter } from 'leancloud-realtime/core';\n","import { Protocals, _Promise, EventEmitter } from './realtime';\n\nconst { CommandType, GenericCommand, AckCommand } = Protocals;\n\nconst warn = error => console.warn(error.message);\n\nexport default class LiveQueryClient extends EventEmitter {\n  constructor(appId, subscriptionId, connection) {\n    super();\n    this._appId = appId;\n    this.id = subscriptionId;\n    this._connection = connection;\n    this._eventemitter = new EventEmitter();\n    this._querys = new Set();\n  }\n\n  _send(cmd, ...args) {\n    return this._connection.send(\n      Object.assign(cmd, {\n        appId: this._appId,\n        installationId: this.id,\n        service: 1,\n      }),\n      ...args\n    );\n  }\n\n  _open() {\n    return this._send(\n      new GenericCommand({\n        cmd: CommandType.login,\n      })\n    );\n  }\n\n  close() {\n    const _ee = this._eventemitter;\n    _ee.emit('beforeclose');\n    return this._send(\n      new GenericCommand({\n        cmd: CommandType.logout,\n      })\n    ).then(() => _ee.emit('close'));\n  }\n\n  register(liveQuery) {\n    this._querys.add(liveQuery);\n  }\n\n  deregister(liveQuery) {\n    this._querys.delete(liveQuery);\n    setTimeout(() => {\n      if (!this._querys.size) this.close().catch(warn);\n    }, 0);\n  }\n\n  _dispatchCommand(command) {\n    if (command.cmd !== CommandType.data) {\n      this.emit('unhandledmessage', command);\n      return _Promise.resolve();\n    }\n    return this._dispatchDataCommand(command);\n  }\n\n  _dispatchDataCommand({ dataMessage: { ids, msg } }) {\n    this.emit('message', msg.map(({ data }) => JSON.parse(data)));\n    // send ack\n    const command = new GenericCommand({\n      cmd: CommandType.ack,\n      ackMessage: new AckCommand({\n        ids,\n      }),\n    });\n    return this._send(command, false).catch(warn);\n  }\n}\n","import { _Promise } from './realtime';\nimport LiveQueryClient from './live-query-client';\n\nconst finalize = callback => [\n  // eslint-disable-next-line no-sequences\n  value => (callback(), value),\n  error => {\n    callback();\n    throw error;\n  },\n];\n\nconst onRealtimeCreate = realtime => {\n  /* eslint-disable no-param-reassign */\n  realtime._liveQueryClients = {};\n  realtime.createLiveQueryClient = subscriptionId => {\n    if (realtime._liveQueryClients[subscriptionId] !== undefined) {\n      return _Promise.resolve(realtime._liveQueryClients[subscriptionId]);\n    }\n    const promise = realtime\n      ._open()\n      .then(connection => {\n        const client = new LiveQueryClient(\n          realtime._options.appId,\n          subscriptionId,\n          connection\n        );\n        connection.on('reconnect', () =>\n          client\n            ._open()\n            .then(\n              () => client.emit('reconnect'),\n              error => client.emit('reconnecterror', error)\n            )\n        );\n        client._eventemitter.on(\n          'beforeclose',\n          () => {\n            delete realtime._liveQueryClients[client.id];\n          },\n          realtime\n        );\n        client._eventemitter.on(\n          'close',\n          () => {\n            realtime._deregister(client);\n          },\n          realtime\n        );\n        return client._open().then(() => {\n          realtime._liveQueryClients[client.id] = client;\n          realtime._register(client);\n          return client;\n        });\n      })\n      .then(\n        ...finalize(() => {\n          if (realtime._deregisterPending) realtime._deregisterPending(promise);\n        })\n      );\n    realtime._liveQueryClients[subscriptionId] = promise;\n    if (realtime._registerPending) realtime._registerPending(promise);\n    return promise;\n  };\n  /* eslint-enable no-param-reassign */\n};\n\nconst beforeCommandDispatch = (command, realtime) => {\n  const isLiveQueryCommand = command.installationId && command.service === 1;\n  if (!isLiveQueryCommand) return true;\n  const targetClient = realtime._liveQueryClients[command.installationId];\n  if (targetClient) {\n    targetClient._dispatchCommand(command).catch(error => console.warn(error));\n  } else {\n    console.warn(\n      'Unexpected message received without any live client match: %O',\n      command\n    );\n  }\n  return false;\n};\n\n// eslint-disable-next-line import/prefer-default-export\nexport const LiveQueryPlugin = {\n  name: 'leancloud-realtime-plugin-live-query',\n  onRealtimeCreate,\n  beforeCommandDispatch,\n};\n"],"names":["Protocals","Error","CommandType","GenericCommand","AckCommand","warn","error","console","message","LiveQueryClient","appId","subscriptionId","connection","_appId","id","_connection","_eventemitter","EventEmitter","_querys","Set","_send","cmd","args","send","Object","assign","installationId","service","_open","login","close","_ee","emit","logout","then","register","liveQuery","add","deregister","delete","setTimeout","size","catch","_dispatchCommand","command","data","_Promise","resolve","_dispatchDataCommand","dataMessage","ids","msg","map","JSON","parse","ack","ackMessage","finalize","callback","value","onRealtimeCreate","realtime","_liveQueryClients","createLiveQueryClient","undefined","promise","client","_options","on","_deregister","_register","_deregisterPending","_registerPending","beforeCommandDispatch","isLiveQueryCommand","targetClient","LiveQueryPlugin","name"],"mappings":"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"}