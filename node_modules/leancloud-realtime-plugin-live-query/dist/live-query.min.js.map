{"version":3,"file":"live-query.min.js","sources":["../src/realtime.js","../src/live-query-client.js","../src/index.js"],"sourcesContent":["/* eslint-disable import/no-unresolved */\nimport { Protocals, Promise as _Promise } from 'leancloud-realtime/core';\n\nif (!Protocals) {\n  throw new Error('LeanCloud Realtime SDK not installed');\n}\nexport { _Promise };\n\nexport { Protocals, EventEmitter } from 'leancloud-realtime/core';\n","import { Protocals, _Promise, EventEmitter } from './realtime';\n\nconst { CommandType, GenericCommand, AckCommand } = Protocals;\n\nconst warn = error => console.warn(error.message);\n\nexport default class LiveQueryClient extends EventEmitter {\n  constructor(appId, subscriptionId, connection) {\n    super();\n    this._appId = appId;\n    this.id = subscriptionId;\n    this._connection = connection;\n    this._eventemitter = new EventEmitter();\n    this._querys = new Set();\n  }\n\n  _send(cmd, ...args) {\n    return this._connection.send(\n      Object.assign(cmd, {\n        appId: this._appId,\n        installationId: this.id,\n        service: 1,\n      }),\n      ...args\n    );\n  }\n\n  _open() {\n    return this._send(\n      new GenericCommand({\n        cmd: CommandType.login,\n      })\n    );\n  }\n\n  close() {\n    const _ee = this._eventemitter;\n    _ee.emit('beforeclose');\n    return this._send(\n      new GenericCommand({\n        cmd: CommandType.logout,\n      })\n    ).then(() => _ee.emit('close'));\n  }\n\n  register(liveQuery) {\n    this._querys.add(liveQuery);\n  }\n\n  deregister(liveQuery) {\n    this._querys.delete(liveQuery);\n    setTimeout(() => {\n      if (!this._querys.size) this.close().catch(warn);\n    }, 0);\n  }\n\n  _dispatchCommand(command) {\n    if (command.cmd !== CommandType.data) {\n      this.emit('unhandledmessage', command);\n      return _Promise.resolve();\n    }\n    return this._dispatchDataCommand(command);\n  }\n\n  _dispatchDataCommand({ dataMessage: { ids, msg } }) {\n    this.emit('message', msg.map(({ data }) => JSON.parse(data)));\n    // send ack\n    const command = new GenericCommand({\n      cmd: CommandType.ack,\n      ackMessage: new AckCommand({\n        ids,\n      }),\n    });\n    return this._send(command, false).catch(warn);\n  }\n}\n","import { _Promise } from './realtime';\nimport LiveQueryClient from './live-query-client';\n\nconst finalize = callback => [\n  // eslint-disable-next-line no-sequences\n  value => (callback(), value),\n  error => {\n    callback();\n    throw error;\n  },\n];\n\nconst onRealtimeCreate = realtime => {\n  /* eslint-disable no-param-reassign */\n  realtime._liveQueryClients = {};\n  realtime.createLiveQueryClient = subscriptionId => {\n    if (realtime._liveQueryClients[subscriptionId] !== undefined) {\n      return _Promise.resolve(realtime._liveQueryClients[subscriptionId]);\n    }\n    const promise = realtime\n      ._open()\n      .then(connection => {\n        const client = new LiveQueryClient(\n          realtime._options.appId,\n          subscriptionId,\n          connection\n        );\n        connection.on('reconnect', () =>\n          client\n            ._open()\n            .then(\n              () => client.emit('reconnect'),\n              error => client.emit('reconnecterror', error)\n            )\n        );\n        client._eventemitter.on(\n          'beforeclose',\n          () => {\n            delete realtime._liveQueryClients[client.id];\n          },\n          realtime\n        );\n        client._eventemitter.on(\n          'close',\n          () => {\n            realtime._deregister(client);\n          },\n          realtime\n        );\n        return client._open().then(() => {\n          realtime._liveQueryClients[client.id] = client;\n          realtime._register(client);\n          return client;\n        });\n      })\n      .then(\n        ...finalize(() => {\n          if (realtime._deregisterPending) realtime._deregisterPending(promise);\n        })\n      );\n    realtime._liveQueryClients[subscriptionId] = promise;\n    if (realtime._registerPending) realtime._registerPending(promise);\n    return promise;\n  };\n  /* eslint-enable no-param-reassign */\n};\n\nconst beforeCommandDispatch = (command, realtime) => {\n  const isLiveQueryCommand = command.installationId && command.service === 1;\n  if (!isLiveQueryCommand) return true;\n  const targetClient = realtime._liveQueryClients[command.installationId];\n  if (targetClient) {\n    targetClient._dispatchCommand(command).catch(error => console.warn(error));\n  } else {\n    console.warn(\n      'Unexpected message received without any live client match: %O',\n      command\n    );\n  }\n  return false;\n};\n\n// eslint-disable-next-line import/prefer-default-export\nexport const LiveQueryPlugin = {\n  name: 'leancloud-realtime-plugin-live-query',\n  onRealtimeCreate,\n  beforeCommandDispatch,\n};\n"],"names":["Protocals","Error","CommandType","GenericCommand","AckCommand","warn","error","console","message","LiveQueryClient","appId","subscriptionId","connection","_appId","id","_connection","_eventemitter","EventEmitter","_querys","Set","_send","cmd","args","send","Object","assign","this","installationId","service","_open","login","close","_ee","emit","logout","then","register","liveQuery","add","deregister","delete","setTimeout","_this2","size","catch","_dispatchCommand","command","data","_Promise","resolve","_dispatchDataCommand","dataMessage","ids","msg","map","JSON","parse","ack","ackMessage","LiveQueryPlugin","name","onRealtimeCreate","realtime","_liveQueryClients","createLiveQueryClient","undefined","callback","promise","client","_options","on","_deregister","_register","_deregisterPending","value","_registerPending","beforeCommandDispatch","targetClient"],"mappings":"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"}